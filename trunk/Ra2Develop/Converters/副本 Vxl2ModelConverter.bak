using System;
using System.Collections.Generic;
using System.Drawing;
using System.Drawing.Imaging;
using System.IO;
using System.Runtime.InteropServices;
using System.Text;
using System.Windows.Forms;
using Ra2Develop.Designers;
using Ra2Develop.Editors.EditableObjects;
using Ra2Reload.Core;
using Ra2Reload.Graphics;
using Ra2Reload.Graphics.Animating;
using Ra2Reload.IO;
using Ra2Reload.Media;
using SlimDX;
using SlimDX.Direct3D9;


namespace Ra2Develop.Converters
{
    public enum Vxl2MdlMode
    {
        Ra2,
        Ts
    }

    public unsafe class Vxl2ModelConverter : ConverterBase
    {
        const string CsfKey = "GUI:Vxl2Mesh";

        [StructLayout(LayoutKind.Sequential, Pack = 1)]
        struct Vector3i
        {
            public short X;
            public short Y;
            public short Z;

            public Vector3i(short x, short y, short z)
            {
                X = x;
                Y = y;
                Z = z;
            }
            public Vector3i(int x, int y, int z)
            {
                X =(short) x;
                Y = (short)y;
                Z = (short)z;
            }


            public static bool operator ==(Vector3i a, Vector3i b)
            {
                return a.X == b.X && a.Y == b.Y && a.Z == b.Z;
            }
            public static bool operator !=(Vector3i a, Vector3i b)
            {
                return a.X != b.X || a.Y != b.Y || a.Z != b.Z;
            }
        }
        struct AdjFaceInfo
        {
            /// <summary>
            /// releative position of a adj face's voxel
            /// </summary>
            public Vector3i vxlPos;
            public VxlFlag face;
        }
        class VxlFace
        {
            public Vector3i[] vtx = new Vector3i[4];
        }

        //struct Texel
        //{
        //    public short x;
        //    public short y;

        //    public byte color;

        //    public short vxlX;
        //    public short vxlY;
        //    public short vxlZ;

        //    public override int GetHashCode()
        //    {
        //        return ((vxlX & 512) << 20) | ((vxlY & 512) << 10) | (vxlZ & 512);
        //    }
        //}

        [Flags()]
        enum VxlFlag : byte
        {
            None = 0,
            Passed = 1,
            FacePosX = 1 << 1,
            FacePosY = 1 << 2,
            FacePosZ = 1 << 3,
            FaceNegX = 1 << 4,
            FaceNegY = 1 << 5,
            FaceNegZ = 1 << 6,

            TexPassed = 1 << 7
        }

        #region Normal Table
        static Vector3[] ra2Normals = new Vector3[244]
        { 
            new Vector3 { X = 0.526578009128571f,    Y = -0.359620988368988f,   Z = -0.770317018032074f },
            new Vector3 { X = 0.150481998920441f,    Y = 0.43598398566246f,     Z = 0.887283980846405f },
            new Vector3 { X = 0.414195001125336f,    Y = 0.738255023956299f,    Z = -0.532374024391174f },
            new Vector3 { X = 0.0751520022749901f,   Y = 0.916248977184296f,    Z = -0.393498003482819f },
            new Vector3 { X = -0.316148996353149f,   Y = 0.930736005306244f,    Z = -0.183792993426323f },
            new Vector3 { X = -0.773819029331207f,   Y = 0.623333990573883f,    Z = -0.112510003149509f },
            new Vector3 { X = -0.900842010974884f,   Y = 0.428537011146545f,    Z = -0.0695680007338524f },
            new Vector3 { X = -0.998942017555237f,   Y = -0.010971000418067f,   Z = 0.0446650013327599f },
            new Vector3 { X = -0.979761004447937f,   Y = -0.157670006155968f,   Z = -0.123323999345303f },
            new Vector3 { X = -0.911274015903473f,   Y = -0.362370997667313f,   Z = -0.195620000362396f },
            new Vector3 { X = -0.624068975448608f,   Y = -0.720941007137299f,   Z = -0.301301002502441f },
            new Vector3 { X = -0.310173004865646f,   Y = -0.809345006942749f,   Z = -0.498751997947693f },
            new Vector3 { X = 0.146613001823425f,    Y = -0.815819025039673f,   Z = -0.559414029121399f },
            new Vector3 { X = -0.716516017913818f,   Y = -0.694356024265289f,   Z = -0.0668879970908165f },
            new Vector3 { X = 0.503971993923187f,    Y = -0.114202000200748f,   Z = -0.856136977672577f },
            new Vector3 { X = 0.455491006374359f,    Y = 0.872627019882202f,    Z = -0.176210999488831f },
            new Vector3 { X = -0.00500999996438622f, Y = -0.114372998476028f,   Z = -0.993425011634827f },
            new Vector3 { X = -0.104675002396107f,   Y = -0.32770100235939f,    Z = -0.938965022563934f },
            new Vector3 { X = 0.560411989688873f,    Y = 0.752588987350464f,    Z = -0.345755994319916f },
            new Vector3 { X = -0.0605759993195534f,  Y = 0.821627974510193f,    Z = -0.566796004772186f },
            new Vector3 { X = -0.302341014146805f,   Y = 0.797007024288178f,    Z = -0.52284699678421f },
            new Vector3 { X = -0.671543002128601f,   Y = 0.670740008354187f,    Z = -0.314862996339798f },
            new Vector3 { X = -0.778401017189026f,   Y = -0.128356993198395f,   Z = 0.614504992961884f },
            new Vector3 { X = -0.924049973487854f,   Y = 0.278382003307343f,    Z = -0.261985003948212f },
            new Vector3 { X = -0.699773013591766f,   Y = -0.550490975379944f,   Z = -0.455278009176254f },
            new Vector3 { X = -0.568247973918915f,   Y = -0.517189025878906f,   Z = -0.640007972717285f },
            new Vector3 { X = 0.0540979988873005f,   Y = -0.932864010334015f,   Z = -0.356142997741699f },
            new Vector3 { X = 0.758382022380829f,    Y = 0.572893023490906f,    Z = -0.31088799238205f },
            new Vector3 { X = 0.00362000009045005f,  Y = 0.305025994777679f,    Z = -0.952337026596069f },
            new Vector3 { X = -0.0608499981462956f,  Y = -0.986886024475098f,   Z = -0.149510994553566f },
            new Vector3 { X = 0.635230004787445f,    Y = 0.0454780012369156f,   Z = -0.770982980728149f },
            new Vector3 { X = 0.521704971790314f,    Y = 0.241309002041817f,    Z = -0.818287014961243f },
            new Vector3 { X = 0.269403994083405f,    Y = 0.635424971580505f,    Z = -0.723640978336334f },
            new Vector3 { X = 0.0456760004162788f,   Y = 0.672753989696503f,    Z = -0.73845499753952f },
            new Vector3 { X = -0.180510997772217f,   Y = 0.674656987190247f,    Z = -0.715718984603882f },
            new Vector3 { X = -0.397130995988846f,   Y = 0.636640012264252f,    Z = -0.661041975021362f },
            new Vector3 { X = -0.552003979682922f,   Y = 0.472514986991882f,    Z = -0.687038004398346f },
            new Vector3 { X = -0.772170007228851f,   Y = 0.0830899998545647f,   Z = -0.629960000514984f },
            new Vector3 { X = -0.669818997383118f,   Y = -0.119533002376556f,   Z = -0.732840001583099f },
            new Vector3 { X = -0.540454983711243f,   Y = -0.318444013595581f,   Z = -0.77878201007843f },
            new Vector3 { X = -0.386135011911392f,   Y = -0.522789001464844f,   Z = -0.759993970394135f },
            new Vector3 { X = -0.26146599650383f,    Y = -0.688566982746124f,   Z = -0.676394999027252f },
            new Vector3 { X = -0.0194119997322559f,  Y = -0.696102976799011f,   Z = -0.717679977416992f },
            new Vector3 { X = 0.303568989038467f,    Y = -0.481844007968903f,   Z = -0.821992993354797f },
            new Vector3 { X = 0.681939005851746f,    Y = -0.195129007101059f,   Z = -0.704900026321411f },
            new Vector3 { X = -0.244889006018639f,   Y = -0.116562001407146f,   Z = -0.962518990039825f },
            new Vector3 { X = 0.800759017467499f,    Y = -0.0229790005832911f,  Z = -0.598546028137207f },
            new Vector3 { X = -0.370274990797043f,   Y = 0.0955839976668358f,   Z = -0.923991024494171f },
            new Vector3 { X = -0.330671012401581f,   Y = -0.326577991247177f,   Z = -0.885439991950989f },
            new Vector3 { X = -0.163220003247261f,   Y = -0.527579009532928f,   Z = -0.833679020404816f },
            new Vector3 { X = 0.126389995217323f,    Y = -0.313145995140076f,   Z = -0.941256999969482f },
            new Vector3 { X = 0.349548012018204f,    Y = -0.272226005792618f,   Z = -0.896498024463654f },
            new Vector3 { X = 0.239917993545532f,    Y = -0.0858250036835671f,  Z = -0.966992020606995f },
            new Vector3 { X = 0.390845000743866f,    Y = 0.0815370008349419f,   Z = -0.916837990283966f },
            new Vector3 { X = 0.2552669942379f,      Y = 0.268696993589401f,    Z = -0.928785026073456f },
            new Vector3 { X = 0.146245002746582f,    Y = 0.480437994003296f,    Z = -0.864749014377594f },
            new Vector3 { X = -0.326016008853912f,   Y = 0.478455990552902f,    Z = -0.815348982810974f },
            new Vector3 { X = -0.46968200802803f,    Y = -0.112519003450871f,   Z = -0.875635981559753f },
            new Vector3 { X = 0.818440020084381f,    Y = -0.258520007133484f,   Z = -0.513150990009308f },
            new Vector3 { X = -0.474317997694015f,   Y = 0.292237997055054f,    Z = -0.830433011054993f },
            new Vector3 { X = 0.778943002223969f,    Y = 0.395841985940933f,    Z = -0.486371010541916f },
            new Vector3 { X = 0.624094009399414f,    Y = 0.39377298951149f,     Z = -0.674870014190674f },
            new Vector3 { X = 0.740885972976685f,    Y = 0.203833997249603f,    Z = -0.639953017234802f },
            new Vector3 { X = 0.480217009782791f,    Y = 0.565768003463745f,    Z = -0.670297026634216f },
            new Vector3 { X = 0.380930006504059f,    Y = 0.424535006284714f,    Z = -0.821377992630005f },
            new Vector3 { X = -0.0934220030903816f,  Y = 0.501124024391174f,    Z = -0.860318005084991f },
            new Vector3 { X = -0.236485004425049f,   Y = 0.296198010444641f,    Z = -0.925387024879456f },
            new Vector3 { X = -0.131531000137329f,   Y = 0.0939590036869049f,   Z = -0.986849009990692f },
            new Vector3 { X = -0.823562026023865f,   Y = 0.29577699303627f,     Z = -0.484005987644196f },
            new Vector3 { X = 0.611065983772278f,    Y = -0.624303996562958f,   Z = -0.486663997173309f },
            new Vector3 { X = 0.0694959983229637f,   Y = -0.520330011844635f,   Z = -0.851132988929748f },
            new Vector3 { X = 0.226521998643875f,    Y = -0.664879024028778f,   Z = -0.711775004863739f },
            new Vector3 { X = 0.471307992935181f,    Y = -0.568903982639313f,   Z = -0.673956990242004f },
            new Vector3 { X = 0.38842499256134f,     Y = -0.74262398481369f,    Z = -0.545560002326965f },
            new Vector3 { X = 0.783675014972687f,    Y = -0.480729013681412f,   Z = -0.393384993076324f },
            new Vector3 { X = 0.962393999099731f,    Y = 0.135675996541977f,    Z = -0.235348999500275f },
            new Vector3 { X = 0.876607000827789f,    Y = 0.172033995389938f,    Z = -0.449405997991562f },
            new Vector3 { X = 0.633405029773712f,    Y = 0.589793026447296f,    Z = -0.500940978527069f },
            new Vector3 { X = 0.182275995612144f,    Y = 0.800657987594605f,    Z = -0.570720970630646f },
            new Vector3 { X = 0.177002996206284f,    Y = 0.764133989810944f,    Z = 0.620297014713287f },
            new Vector3 { X = -0.544016003608704f,   Y = 0.675514996051788f,    Z = -0.497720986604691f },
            new Vector3 { X = -0.679296970367432f,   Y = 0.286466985940933f,    Z = -0.675642013549805f },
            new Vector3 { X = -0.590390980243683f,   Y = 0.0913690030574799f,   Z = -0.801928997039795f },
            new Vector3 { X = -0.824360013008118f,   Y = -0.133123993873596f,   Z = -0.550189018249512f },
            new Vector3 { X = -0.715794026851654f,   Y = -0.334542006254196f,   Z = -0.612960994243622f },
            new Vector3 { X = 0.174285992980003f,    Y = -0.8924840092659f,     Z = 0.416049003601074f },
            new Vector3 { X = -0.0825280025601387f,  Y = -0.837122976779938f,   Z = -0.54075300693512f },
            new Vector3 { X = 0.283331006765366f,    Y = -0.88087397813797f,    Z = -0.379189014434814f },
            new Vector3 { X = 0.675134003162384f,    Y = -0.42662701010704f,    Z = -0.601817011833191f },
            new Vector3 { X = 0.843720018863678f,    Y = -0.512335002422333f,   Z = -0.16015599668026f },
            new Vector3 { X = 0.977303981781006f,    Y = -0.0985559970140457f,  Z = -0.187519997358322f },
            new Vector3 { X = 0.84629499912262f,     Y = 0.52267199754715f,     Z = -0.102946996688843f },
            new Vector3 { X = 0.677141010761261f,    Y = 0.721324980258942f,    Z = -0.145501002669334f },
            new Vector3 { X = 0.320964992046356f,    Y = 0.870891988277435f,    Z = -0.372193992137909f },
            new Vector3 { X = -0.178977996110916f,   Y = 0.911532998085022f,    Z = -0.37023600935936f },
            new Vector3 { X = -0.447169005870819f,   Y = 0.826700985431671f,    Z = -0.341473996639252f },
            new Vector3 { X = -0.703203022480011f,   Y = 0.496327996253967f,    Z = -0.50908100605011f },
            new Vector3 { X = -0.977181017398834f,   Y = 0.0635629966855049f,   Z = -0.202674001455307f },
            new Vector3 { X = -0.878170013427734f,   Y = -0.412937998771667f,   Z = 0.241455003619194f },
            new Vector3 { X = -0.835830986499786f,   Y = -0.358550012111664f,   Z = -0.415728002786636f },
            new Vector3 { X = -0.499173998832703f,   Y = -0.693432986736298f,   Z = -0.519591987133026f },
            new Vector3 { X = -0.188788995146751f,   Y = -0.923753023147583f,   Z = -0.333225011825562f },
            new Vector3 { X = 0.19225400686264f,     Y = -0.969361007213593f,   Z = -0.152896001935005f },
            new Vector3 { X = 0.515940010547638f,    Y = -0.783906996250153f,   Z = -0.345391988754272f },
            new Vector3 { X = 0.90592497587204f,     Y = -0.300951987504959f,   Z = -0.297870993614197f },
            new Vector3 { X = 0.991111993789673f,    Y = -0.127746000885963f,   Z = 0.0371069982647896f },
            new Vector3 { X = 0.995135009288788f,    Y = 0.0984240025281906f,   Z = -0.0043830000795424f },
            new Vector3 { X = 0.760123014450073f,    Y = 0.646277010440826f,    Z = 0.0673670023679733f },
            new Vector3 { X = 0.205220997333527f,    Y = 0.95958000421524f,     Z = -0.192590996623039f },
            new Vector3 { X = -0.0427500009536743f,  Y = 0.979512989521027f,    Z = -0.196790993213654f },
            new Vector3 { X = -0.438017010688782f,   Y = 0.898926973342895f,    Z = 0.00849200040102005f },
            new Vector3 { X = -0.821994006633759f,   Y = 0.480785012245178f,    Z = -0.305238991975784f },
            new Vector3 { X = -0.899917006492615f,   Y = 0.0817100033164024f,   Z = -0.428337007761002f },
            new Vector3 { X = -0.926612019538879f,   Y = -0.144618004560471f,   Z = -0.347095996141434f },
            new Vector3 { X = -0.79365998506546f,    Y = -0.557792007923126f,   Z = -0.242838993668556f },
            new Vector3 { X = -0.431349992752075f,   Y = -0.847778975963593f,   Z = -0.308557987213135f },
            new Vector3 { X = -0.00549199990928173f, Y = -0.964999973773956f,   Z = 0.262192994356155f },
            new Vector3 { X = 0.587904989719391f,    Y = -0.804026007652283f,   Z = -0.0889400020241737f },
            new Vector3 { X = 0.699492990970612f,    Y = -0.667685985565186f,   Z = -0.254765003919601f },
            new Vector3 { X = 0.889303028583527f,    Y = 0.35979500412941f,     Z = -0.282290995121002f },
            new Vector3 { X = 0.780972003936768f,    Y = 0.197036996483803f,    Z = 0.592671990394592f },
            new Vector3 { X = 0.520120978355408f,    Y = 0.506695985794067f,    Z = 0.687556982040405f },
            new Vector3 { X = 0.403894990682602f,    Y = 0.693961024284363f,    Z = 0.59605997800827f },
            new Vector3 { X = -0.154982998967171f,   Y = 0.899236023426056f,    Z = 0.409090012311935f },
            new Vector3 { X = -0.65733802318573f,    Y = 0.537168025970459f,    Z = 0.528542995452881f },
            new Vector3 { X = -0.746195018291473f,   Y = 0.334091007709503f,    Z = 0.57582700252533f },
            new Vector3 { X = -0.624952018260956f,   Y = -0.0491439998149872f,  Z = 0.77911502122879f },
            new Vector3 { X = 0.318141013383865f,    Y = -0.254714995622635f,   Z = 0.913185000419617f },
            new Vector3 { X = -0.555896997451782f,   Y = 0.405294001102447f,    Z = 0.725751996040344f },
            new Vector3 { X = -0.794434010982513f,   Y = 0.0994059965014458f,   Z = 0.599160015583038f },
            new Vector3 { X = -0.64036101102829f,    Y = -0.689463019371033f,   Z = 0.3384949862957f },
            new Vector3 { X = -0.126712992787361f,   Y = -0.734094977378845f,   Z = 0.667119979858398f },
            new Vector3 { X = 0.105457000434399f,    Y = -0.780816972255707f,   Z = 0.615795016288757f },
            new Vector3 { X = 0.407992988824844f,    Y = -0.480915993452072f,   Z = 0.776054978370666f },
            new Vector3 { X = 0.69513601064682f,     Y = -0.545120000839233f,   Z = 0.468647003173828f },
            new Vector3 { X = 0.973191022872925f,    Y = -0.00648899981752038f, Z = 0.229908004403114f },
            new Vector3 { X = 0.946893990039825f,    Y = 0.31750899553299f,     Z = -0.0507990010082722f },
            new Vector3 { X = 0.563583016395569f,    Y = 0.825612008571625f,    Z = 0.0271829999983311f },
            new Vector3 { X = 0.325773000717163f,    Y = 0.945423007011414f,    Z = 0.00694900006055832f },
            new Vector3 { X = -0.171820998191834f,   Y = 0.985096991062164f,    Z = -0.00781499966979027f },
            new Vector3 { X = -0.670440971851349f,   Y = 0.739938974380493f,    Z = 0.0547689981758594f },
            new Vector3 { X = -0.822980999946594f,   Y = 0.554961979389191f,    Z = 0.121321998536587f },
            new Vector3 { X = -0.96619302034378f,    Y = 0.117857001721859f,    Z = 0.229306995868683f },
            new Vector3 { X = -0.953769028186798f,   Y = -0.294703990221024f,   Z = 0.0589450001716614f },
            new Vector3 { X = -0.864386975765228f,   Y = -0.50272798538208f,    Z = -0.0100149996578693f },
            new Vector3 { X = -0.530609011650085f,   Y = -0.842006027698517f,   Z = -0.0973659977316856f },
            new Vector3 { X = -0.16261799633503f,    Y = -0.984075009822845f,   Z = 0.071772001683712f },
            new Vector3 { X = 0.081446997821331f,    Y = -0.996011018753052f,   Z = 0.0364390015602112f },
            new Vector3 { X = 0.745984017848968f,    Y = -0.665962994098663f,   Z = 0.000761999981477857f },
            new Vector3 { X = 0.942057013511658f,    Y = -0.329268991947174f,   Z = -0.0641060024499893f },
            new Vector3 { X = 0.939701974391937f,    Y = -0.2810899913311f,     Z = 0.19480299949646f },
            new Vector3 { X = 0.771214008331299f,    Y = 0.550670027732849f,    Z = 0.319362998008728f },
            new Vector3 { X = 0.641348004341126f,    Y = 0.730690002441406f,    Z = 0.234020993113518f },
            new Vector3 { X = 0.0806820020079613f,   Y = 0.996690988540649f,    Z = 0.00987899955362082f },
            new Vector3 { X = -0.0467250011861324f,  Y = 0.976643025875092f,    Z = 0.209725007414818f },
            new Vector3 { X = -0.531076014041901f,   Y = 0.821000993251801f,    Z = 0.209562003612518f },
            new Vector3 { X = -0.695815026760101f,   Y = 0.65599000453949f,     Z = 0.292434990406036f },
            new Vector3 { X = -0.97612202167511f,    Y = 0.21670900285244f,     Z = -0.0149130001664162f },
            new Vector3 { X = -0.961660981178284f,   Y = -0.144128993153572f,   Z = 0.233313992619514f },
            new Vector3 { X = -0.77208399772644f,    Y = -0.613646984100342f,   Z = 0.165298998355865f },
            new Vector3 { X = -0.449600011110306f,   Y = -0.836059987545013f,   Z = 0.314426004886627f },
            new Vector3 { X = -0.392699986696243f,   Y = -0.914615988731384f,   Z = 0.0962470024824142f },
            new Vector3 { X = 0.390588998794556f,    Y = -0.919470012187958f,   Z = 0.0448900014162064f },
            new Vector3 { X = 0.582529008388519f,    Y = -0.799197971820831f,   Z = 0.148127004504204f },
            new Vector3 { X = 0.866430997848511f,    Y = -0.489811986684799f,   Z = 0.0968639999628067f },
            new Vector3 { X = 0.904586970806122f,    Y = 0.11149799823761f,     Z = 0.411449998617172f },
            new Vector3 { X = 0.953536987304687f,    Y = 0.232329994440079f,    Z = 0.191806003451347f },
            new Vector3 { X = 0.497310996055603f,    Y = 0.770802974700928f,    Z = 0.398176997900009f },
            new Vector3 { X = 0.194066002964973f,    Y = 0.956319987773895f,    Z = 0.218611001968384f },
            new Vector3 { X = 0.422876000404358f,    Y = 0.882275998592377f,    Z = 0.206797003746033f },
            new Vector3 { X = -0.373796999454498f,   Y = 0.849565982818604f,    Z = 0.372173994779587f },
            new Vector3 { X = -0.534497022628784f,   Y = 0.714022994041443f,    Z = 0.452199995517731f },
            new Vector3 { X = -0.881826996803284f,   Y = 0.237159997224808f,    Z = 0.407597988843918f },
            new Vector3 { X = -0.904947996139526f,   Y = -0.0140690002590418f,  Z = 0.425289005041122f },
            new Vector3 { X = -0.751827001571655f,   Y = -0.512817025184631f,   Z = 0.414458006620407f },
            new Vector3 { X = -0.50101500749588f,    Y = -0.697916984558105f,   Z = 0.511758029460907f },
            new Vector3 { X = -0.235190004110336f,   Y = -0.925922989845276f,   Z = 0.295554995536804f },
            new Vector3 { X = 0.228982999920845f,    Y = -0.953939974308014f,   Z = 0.193819001317024f },
            new Vector3 { X = 0.734025001525879f,    Y = -0.634898006916046f,   Z = 0.241062000393867f },
            new Vector3 { X = 0.913752973079681f,    Y = -0.0632530003786087f,  Z = -0.401315987110138f },
            new Vector3 { X = 0.905735015869141f,    Y = -0.161486998200417f,   Z = 0.391874998807907f },
            new Vector3 { X = 0.858929991722107f,    Y = 0.342445999383926f,    Z = 0.380748987197876f },
            new Vector3 { X = 0.624486029148102f,    Y = 0.60758101940155f,     Z = 0.490776985883713f },
            new Vector3 { X = 0.289263993501663f,    Y = 0.857478976249695f,    Z = 0.425507992506027f },
            new Vector3 { X = 0.0699680000543594f,   Y = 0.902168989181519f,    Z = 0.425671011209488f },
            new Vector3 { X = -0.28617998957634f,    Y = 0.940699994564056f,    Z = 0.182164996862411f },
            new Vector3 { X = -0.574012994766235f,   Y = 0.805118978023529f,    Z = -0.149308994412422f },
            new Vector3 { X = 0.111258000135422f,    Y = 0.0997179970145225f,   Z = -0.988776028156281f },
            new Vector3 { X = -0.305393010377884f,   Y = -0.944227993488312f,   Z = -0.123159997165203f },
            new Vector3 { X = -0.601166009902954f,   Y = -0.78957599401474f,    Z = 0.123162999749184f },
            new Vector3 { X = -0.290645003318787f,   Y = -0.812139987945557f,   Z = 0.505918979644775f },
            new Vector3 { X = -0.064920000731945f,   Y = -0.877162992954254f,   Z = 0.475784987211227f },
            new Vector3 { X = 0.408300995826721f,    Y = -0.862215995788574f,   Z = 0.299789011478424f },
            new Vector3 { X = 0.566097021102905f,    Y = -0.725566029548645f,   Z = 0.391263991594315f },
            new Vector3 { X = 0.839363992214203f,    Y = -0.427386999130249f,   Z = 0.335869014263153f },
            new Vector3 { X = 0.818899989128113f,    Y = -0.0413050018250942f,  Z = 0.572448015213013f },
            new Vector3 { X = 0.719784021377564f,    Y = 0.414997011423111f,    Z = 0.556496977806091f },
            new Vector3 { X = 0.881744027137756f,    Y = 0.450269997119904f,    Z = 0.140659004449844f },
            new Vector3 { X = 0.40182301402092f,     Y = -0.898220002651215f,   Z = -0.178151994943619f },
            new Vector3 { X = -0.0540199987590313f,  Y = 0.791343986988068f,    Z = 0.608980000019074f },
            new Vector3 { X = -0.293774008750916f,   Y = 0.763993978500366f,    Z = 0.574464976787567f },
            new Vector3 { X = -0.450798004865646f,   Y = 0.610346972942352f,    Z = 0.651350975036621f },
            new Vector3 { X = -0.638221025466919f,   Y = 0.186693996191025f,    Z = 0.746873021125793f },
            new Vector3 { X = -0.872870028018951f,   Y = -0.257126986980438f,   Z = 0.414707988500595f },
            new Vector3 { X = -0.587257027626038f,   Y = -0.521709978580475f,   Z = 0.618827998638153f },
            new Vector3 { X = -0.353657990694046f,   Y = -0.641973972320557f,   Z = 0.680290997028351f },
            new Vector3 { X = 0.0416489988565445f,   Y = -0.611272990703583f,   Z = 0.79032301902771f },
            new Vector3 { X = 0.348342001438141f,    Y = -0.779182970523834f,   Z = 0.521086990833282f },
            new Vector3 { X = 0.499166995286942f,    Y = -0.622440993785858f,   Z = 0.602825999259949f },
            new Vector3 { X = 0.790018975734711f,    Y = -0.3038310110569f,     Z = 0.53250002861023f },
            new Vector3 { X = 0.660117983818054f,    Y = 0.0607330016791821f,   Z = 0.748701989650726f },
            new Vector3 { X = 0.604920983314514f,    Y = 0.29416099190712f,     Z = 0.739960014820099f },
            new Vector3 { X = 0.38569700717926f,     Y = 0.379346013069153f,    Z = 0.841032028198242f },
            new Vector3 { X = 0.239693000912666f,    Y = 0.207875996828079f,    Z = 0.948332011699677f },
            new Vector3 { X = 0.012622999958694f,    Y = 0.258531987667084f,    Z = 0.965919971466065f },
            new Vector3 { X = -0.100556999444962f,   Y = 0.457147002220154f,    Z = 0.883687973022461f },
            new Vector3 { X = 0.0469669997692108f,   Y = 0.628588020801544f,    Z = 0.776319026947021f },
            new Vector3 { X = -0.430391013622284f,   Y = -0.445405006408691f,   Z = 0.785097002983093f },
            new Vector3 { X = -0.434291005134583f,   Y = -0.196227997541428f,   Z = 0.879139006137848f },
            new Vector3 { X = -0.256637006998062f,   Y = -0.33686700463295f,    Z = 0.905902028083801f },
            new Vector3 { X = -0.131372004747391f,   Y = -0.158910006284714f,   Z = 0.978514015674591f },
            new Vector3 { X = 0.102379001677036f,    Y = -0.208766996860504f,   Z = 0.972591996192932f },
            new Vector3 { X = 0.195686995983124f,    Y = -0.450129002332687f,   Z = 0.871258020401001f },
            new Vector3 { X = 0.627318978309631f,    Y = -0.42314800620079f,    Z = 0.653770983219147f },
            new Vector3 { X = 0.687439024448395f,    Y = -0.171582996845245f,   Z = 0.70568197965622f },
            new Vector3 { X = 0.275920003652573f,    Y = -0.021254999563098f,   Z = 0.960946023464203f },
            new Vector3 { X = 0.459367007017136f,    Y = 0.157465994358063f,    Z = 0.874177992343903f },
            new Vector3 { X = 0.285394996404648f,    Y = 0.583184003829956f,    Z = 0.760555982589722f },
            new Vector3 { X = -0.812174022197723f,   Y = 0.460303008556366f,    Z = 0.358460992574692f },
            new Vector3 { X = -0.189068004488945f,   Y = 0.641223013401032f,    Z = 0.743698000907898f },
            new Vector3 { X = -0.338874995708466f,   Y = 0.476480007171631f,    Z = 0.811251997947693f },
            new Vector3 { X = -0.920993983745575f,   Y = 0.347185999155045f,    Z = 0.176726996898651f },
            new Vector3 { X = 0.0406389981508255f,   Y = 0.024465000256896f,    Z = 0.998874008655548f },
            new Vector3 { X = -0.739131987094879f,   Y = -0.353747010231018f,   Z = 0.573189973831177f },
            new Vector3 { X = -0.603511989116669f,   Y = -0.286615014076233f,   Z = 0.744059979915619f },
            new Vector3 { X = -0.188675999641418f,   Y = -0.547058999538422f,   Z = 0.815554022789001f },
            new Vector3 { X = -0.0260450001806021f,  Y = -0.397819995880127f,   Z = 0.917093992233276f },
            new Vector3 { X = 0.267897009849548f,    Y = -0.649040997028351f,   Z = 0.712023019790649f },
            new Vector3 { X = 0.518245995044708f,    Y = -0.28489100933075f,    Z = 0.806385993957519f },
            new Vector3 { X = 0.493450999259949f,    Y = -0.0665329992771149f,  Z = 0.867224991321564f },
            new Vector3 { X = -0.328188002109528f,   Y = 0.140250995755196f,    Z = 0.934143006801605f },
            new Vector3 { X = -0.328188002109528f,   Y = 0.140250995755196f,    Z = 0.934143006801605f },
            new Vector3 { X = -0.328188002109528f,   Y = 0.140250995755196f,    Z = 0.934143006801605f },
            new Vector3 { X = -0.328188002109528f,   Y = 0.140250995755196f,    Z = 0.934143006801605f }
        };
        static Vector3[] tsNormals = new Vector3[36]
        {
            new Vector3 { X = 0.671213984489441f,   Y = 0.198492005467415f,     Z = -0.714193999767303f },
            new Vector3 { X = 0.269643008708954f,   Y = 0.584393978118897f,     Z = -0.765359997749329f },
            new Vector3 { X = -0.0405460000038147f, Y = 0.0969879999756813f,    Z = -0.994458973407745f },
            new Vector3 { X = -0.572427988052368f,  Y = -0.0919139981269836f,   Z = -0.814786970615387f },
            new Vector3 { X = -0.171400994062424f,  Y = -0.572709977626801f,    Z = -0.801639020442963f },
            new Vector3 { X = 0.362556993961334f,   Y = -0.30299898982048f,     Z = -0.881331026554108f },
            new Vector3 { X = 0.810347020626068f,   Y = -0.348971992731094f,    Z = -0.470697999000549f },
            new Vector3 { X = 0.103961996734142f,   Y = 0.938672006130218f,     Z = -0.328767001628876f },
            new Vector3 { X = -0.32404699921608f,   Y = 0.587669014930725f,     Z = -0.741375982761383f },
            new Vector3 { X = -0.800864994525909f,  Y = 0.340460985898972f,     Z = -0.492646992206574f },
            new Vector3 { X = -0.665498018264771f,  Y = -0.590147018432617f,    Z = -0.456988990306854f },
            new Vector3 { X = 0.314767003059387f,   Y = -0.803001999855042f,    Z = -0.506072998046875f },
            new Vector3 { X = 0.972629010677338f,   Y = 0.151076003909111f,     Z = -0.176550000905991f },
            new Vector3 { X = 0.680290997028351f,   Y = 0.684235990047455f,     Z = -0.262726992368698f },
            new Vector3 { X = -0.520079016685486f,  Y = 0.827777028083801f,     Z = -0.210482999682426f },
            new Vector3 { X = -0.961643993854523f,  Y = -0.179001003503799f,    Z = -0.207846999168396f },
            new Vector3 { X = -0.262713998556137f,  Y = -0.937451004981995f,    Z = -0.228401005268097f },
            new Vector3 { X = 0.219706997275352f,   Y = -0.971301019191742f,    Z = 0.0911249965429306f },
            new Vector3 { X = 0.923807978630066f,   Y = -0.229975000023842f,    Z = 0.306086987257004f },
            new Vector3 { X = -0.0824889987707138f, Y = 0.970659971237183f,     Z = 0.225866004824638f },
            new Vector3 { X = -0.591798007488251f,  Y = 0.696789979934692f,     Z = 0.405288994312286f },
            new Vector3 { X = -0.925296008586884f,  Y = 0.36660099029541f,      Z = 0.0971110016107559f },
            new Vector3 { X = -0.705051004886627f,  Y = -0.687775015830994f,    Z = 0.172828003764153f },
            new Vector3 { X = 0.732400000095367f,   Y = -0.680366992950439f,    Z = -0.0263049993664026f },
            new Vector3 { X = 0.855162024497986f,   Y = 0.37458199262619f,      Z = 0.358310997486114f },
            new Vector3 { X = 0.473006010055542f,   Y = 0.836480021476746f,     Z = 0.276704996824265f },
            new Vector3 { X = -0.0976170003414154f, Y = 0.654111981391907f,     Z = 0.750072002410889f },
            new Vector3 { X = -0.904124021530151f,  Y = -0.153724998235703f,    Z = 0.398658007383347f },
            new Vector3 { X = -0.211915999650955f,  Y = -0.858089983463287f,    Z = 0.467732012271881f },
            new Vector3 { X = 0.500226974487305f,   Y = -0.67440801858902f,     Z = 0.543090999126434f },
            new Vector3 { X = 0.584538996219635f,   Y = -0.110248997807503f,    Z = 0.8038409948349f },
            new Vector3 { X = 0.437373012304306f,   Y = 0.454643994569778f,     Z = 0.775888979434967f },
            new Vector3 { X = -0.0424409992992878f, Y = 0.0833180025219917f,    Z = 0.995618999004364f },
            new Vector3 { X = -0.596251010894775f,  Y = 0.220131993293762f,     Z = 0.772028028964996f },
            new Vector3 { X = -0.50645500421524f,   Y = -0.396977007389069f,    Z = 0.765448987483978f },
            new Vector3 { X = 0.0705690011382103f,  Y = -0.478473991155624f,    Z = 0.875262022018433f }
        };
        #endregion

        //[Flags()]
        //enum BoundFlag : int
        //{
        //    None = 0,
        //    IGZ = 1,
        //    JGZ = 1 << 1,
        //    KGZ = 1 << 2,
        //    ILL = 1 << 3,
        //    JLL = 1 << 4,
        //    KLL = 1 << 5
        //}

        float scale = 4f / 50f;

        public float Scale
        {
            get { return scale; }
            set { scale = value; }
        }
        public Vxl2MdlMode Mode
        {
            get;
            set;
        }
        public Palette Palette
        {
            get;
            set;
        }
        public HVA HVA
        {
            get;
            set;
        }
        void AddQuad(ref VertexPNT1 vtx1, ref VertexPNT1 vtx2,
            ref VertexPNT1 vtx3, ref VertexPNT1 vtx4,
            List<MeshFace> faces, List<VertexPNT1> vertices, Dictionary<string, int> table)
        {
            int f1a;// = vertices.Count;
            int f1b;// = f1a + 1;
            int f1c;// = f1a + 2;
            int f2a;// = f1a;
            int f2b;// = f1a + 2;
            int f2c;// = f1a + 3;


            string desc = vtx1.ToString();
            int index;
            if (table.TryGetValue(desc, out index))
            {
                f1a = index;
                f2a = index;
            }
            else
            {
                table.Add(desc, vertices.Count);
                f1a = vertices.Count;
                f2a = f1a;
                vertices.Add(vtx1);
            }

            desc = vtx2.ToString();
            if (table.TryGetValue(desc, out index))
            {
                f1b = index;
            }
            else
            {
                table.Add(desc, vertices.Count);
                f1b = vertices.Count;
                vertices.Add(vtx2);
            }

            desc = vtx3.ToString();
            if (table.TryGetValue(desc, out index))
            {
                f1c = index;
                f2b = index;
            }
            else
            {
                table.Add(desc, vertices.Count);
                f1c = vertices.Count;
                f2b = f1c;
                vertices.Add(vtx3);
            }

            desc = vtx4.ToString();
            if (table.TryGetValue(desc, out index))
            {
                f2c = index;
            }
            else
            {
                table.Add(desc, vertices.Count);
                f2c = vertices.Count;
                vertices.Add(vtx4);
            }

            MeshFace face1 = new MeshFace(f1a, f1b, f1c, 0);
            MeshFace face2 = new MeshFace(f2a, f2b, f2c, 0);
            faces.Add(face1);
            faces.Add(face2);
        }

        bool CheckVertex(VxlFlag[][][] flagsTable, VoxelData[][][] data, int i, int j, int k)
        {
            //BoundFlag flag = BoundFlag.None;
            bool iIn = i < data.Length;
            bool jIn = j < data[0].Length;
            bool kIn = k < data[0][0].Length;
            //if (i < data.Length)
            //    flag |= BoundFlag.ILL;
            //if (j < data[0].Length)
            //    flag |= BoundFlag.JLL;
            //if (k < data[0][0].Length)
            //    flag |= BoundFlag.KLL;

            //if (i>0)
            //    flag |= BoundFlag.

            if (kIn)
            {
                if (i > 0)
                {
                    if (j > 0 && data[i - 1][j - 1][k].used && flagsTable[i - 1][j - 1][k] != VxlFlag.None)
                        return true;
                    if (jIn && data[i - 1][j][k].used && flagsTable[i - 1][j][k] != VxlFlag.None)
                        return true;
                }

                if (iIn)
                {
                    if (j > 0 && data[i][j - 1][k].used && flagsTable[i][j - 1][k] != VxlFlag.None)
                        return true;

                    if (jIn && data[i][j][k].used && flagsTable[i][j][k] != VxlFlag.None)
                        return true;
                }

            }

            if (k > 0)
            {
                k--;
                if (i > 0)
                {
                    if (j > 0 && data[i - 1][j - 1][k].used && flagsTable[i - 1][j - 1][k] != VxlFlag.None)
                        return true;
                    if (jIn && data[i - 1][j][k].used && flagsTable[i - 1][j][k] != VxlFlag.None)
                        return true;
                }

                if (iIn)
                {
                    if (j > 0 && data[i][j - 1][k].used && flagsTable[i][j - 1][k] != VxlFlag.None)
                        return true;

                    if (jIn && data[i][j][k].used && flagsTable[i][j][k] != VxlFlag.None)
                        return true;
                }


            }

            return false;
        }



        VxlFlag[][][] CreatePassedTable(int ecx, int ecy, int ecz)
        {
            VxlFlag[][][] passed = new VxlFlag[ecx][][];
            for (int i = 0; i < ecx; i++)
            {
                passed[i] = new VxlFlag[ecy][];
                for (int j = 0; j < ecy; j++)
                {
                    passed[i][j] = new VxlFlag[ecz];
                }
            }
            return passed;
        }
        VoxelData[][][] GetData(VoxelSection sect, int ecx, int ecy, int ecz)
        {
            VoxelData[][][] data = new VoxelData[ecx][][];// sect.Data;

            for (int i = 0; i < ecx; i++)
            {
                data[i] = new VoxelData[ecy][];
                for (int j = 0; j < ecy; j++)
                {
                    data[i][j] = new VoxelData[ecz];

                    if (i >= 1 && j >= 1 && i < ecx - 1 && j < ecy - 1)
                    {
                        Array.Copy(sect.Data[i - 1][j - 1], 0, data[i][j], 1, ecz - 2);
                    }
                }
            }
            return data;
        }

        void MarkVxlFlags(VoxelData[][][] data, VxlFlag[][][] passed, int ecx, int ecy, int ecz)
        {
            Queue<Vector3i> q = new Queue<Vector3i>(ecx * ecy * ecz);
            q.Enqueue(new Vector3i(0, 0, 0));
            passed[0][0][0] = VxlFlag.Passed;

            VxlFlag[] stateEnumFlag = new VxlFlag[]
                {
                    VxlFlag.FacePosX, VxlFlag.FacePosY, VxlFlag.FacePosZ, 
                    VxlFlag.FaceNegX, VxlFlag.FaceNegY, VxlFlag.FaceNegZ
                };
            Vector3i[] stateEnum = new Vector3i[]
                {
                    new Vector3i(-1, 0, 0), new Vector3i(0, -1, 0), new Vector3i(0, 0, -1),
                    new Vector3i(1, 0, 0), new Vector3i(0, 1, 0), new Vector3i(0, 0, 1)
                };

            while (q.Count > 0)
            {
                Vector3i pos = q.Dequeue();

                for (int j = 0; j < 6; j++)
                {
                    Vector3i ns = pos;
                    ns.X += stateEnum[j].X;
                    ns.Y += stateEnum[j].Y;
                    ns.Z += stateEnum[j].Z;

                    if (ns.X >= 0 && ns.Y >= 0 && ns.Z >= 0 &&
                        ns.X < ecx && ns.Y < ecy && ns.Z < ecz)
                    {
                        if (!data[ns.X][ns.Y][ns.Z].used)
                        {
                            if ((passed[ns.X][ns.Y][ns.Z] & VxlFlag.Passed) == 0)
                            {
                                passed[ns.X][ns.Y][ns.Z] = VxlFlag.Passed;
                                q.Enqueue(ns);
                            }
                        }
                        else
                        {
                            if ((passed[ns.X][ns.Y][ns.Z] & stateEnumFlag[j]) == 0)
                            {
                                passed[ns.X][ns.Y][ns.Z] |= stateEnumFlag[j];
                            }
                        }
                    }
                } // for state enum
            }

        }

        Vector3[][][] CreateSmoothedPosition( Vector3[][][] buffer,VoxelData[][][] data, VxlFlag[][][] passed, int ecx, int ecy, int ecz)
        {
            int vx = ecx + 1;
            int vy = ecy + 1;
            int vz = ecz + 1;

            Vector3[][][] smoothed = new Vector3[vx][][];
            for (int i = 0; i < vx; i++)
            {
                smoothed[i] = new Vector3[vy][];
                for (int j = 0; j < vy; j++)
                {
                    smoothed[i][j] = new Vector3[vz];

                    //Array.Copy(buffer[i][j], smoothed[i][j], vz);

                    for (int k = 0; k < vz; k++)
                    {
                        smoothed[i][j][k] = buffer[i][j][k];
                        if (i > 0 && j > 0 && k > 0 &&
                            i < ecx && j < ecy && k < ecz)
                        {
                            if (CheckVertex(passed, data, i, j, k))
                            {
                                int count = 0;
                                Vector3 avgPos = new Vector3();

                                for (int a = -1; a < 2; a++)
                                    for (int b = -1; b < 2; b++)
                                        for (int c = -1; c < 2; c++)
                                        {
                                            int ii = i + a;
                                            int jj = j + b;
                                            int kk = k + c;

                                            if (CheckVertex(passed, data, ii, jj, kk))
                                            {
                                                count++;
                                                avgPos.X += buffer[ii][jj][kk].X;
                                                avgPos.Y += buffer[ii][jj][kk].Y;
                                                avgPos.Z += buffer[ii][jj][kk].Z;
                                            }
                                        }

                                if (count > 1)
                                {

                                    avgPos.X -= buffer[i][j][k].X;
                                    avgPos.Y -= buffer[i][j][k].Y;
                                    avgPos.Z -= buffer[i][j][k].Z;

                                    float inv = 1f / (float)(count - 1);
                                    avgPos.X *= inv; avgPos.Y *= inv; avgPos.Z *= inv;

                                    //Vector3 offset = new Vector3(avgPos.X - buffer[i][j][k].X, avgPos.Y - buffer[i][j][k].Y, avgPos.Z - buffer[i][j][k].Z);

                                    //avgPos.X *= 0.5f; avgPos.Y *= 0.5f; avgPos.Z *= 0.5f;


                                    avgPos.X += 0.5f * (avgPos.X - buffer[i][j][k].X);
                                    avgPos.Y += 0.5f * (avgPos.Y - buffer[i][j][k].Y);
                                    avgPos.Z += 0.5f * (avgPos.Z - buffer[i][j][k].Z);

                                    smoothed[i][j][k] = avgPos;
                                }
                                else
                                {
                                    smoothed[i][j][k] = buffer[i][j][k];
                                }
                            }
                        }



                    }
                }
            }
            return smoothed;
        }
        Vector3[][][] CreateSmoothedPosition(VoxelData[][][] data, VxlFlag[][][] passed, int ecx, int ecy, int ecz) 
        {
            int vx = ecx + 1;
            int vy = ecy + 1;
            int vz = ecz + 1;

            Vector3[][][] buffer = CreatePosition(data, passed, ecx, ecy, ecz);
 
            Vector3[][][] smoothed = new Vector3[vx][][];
            for (int i = 0; i < vx; i++)
            {
                smoothed[i] = new Vector3[vy][];
                for (int j = 0; j < vy; j++)
                {
                    smoothed[i][j] = new Vector3[vz];

                    //Array.Copy(buffer[i][j], smoothed[i][j], vz);

                    for (int k = 0; k < vz; k++)
                    {
                        smoothed[i][j][k] = buffer[i][j][k];
                        if (i > 0 && j > 0 && k > 0 &&
                            i < ecx && j < ecy && k < ecz)
                        {
                            if (CheckVertex(passed, data, i, j, k))
                            {
                                int count = 0;
                                Vector3 avgPos = new Vector3();

                                for (int a = -1; a < 2; a++)
                                    for (int b = -1; b < 2; b++)
                                        for (int c = -1; c < 2; c++)
                                        {
                                            int ii = i + a;
                                            int jj = j + b;
                                            int kk = k + c;

                                            if (CheckVertex(passed, data, ii, jj, kk))
                                            {
                                                count++;
                                                avgPos.X += buffer[ii][jj][kk].X;
                                                avgPos.Y += buffer[ii][jj][kk].Y;
                                                avgPos.Z += buffer[ii][jj][kk].Z;
                                            }
                                        }

                                if (count > 1)
                                {

                                    avgPos.X -= buffer[i][j][k].X;
                                    avgPos.Y -= buffer[i][j][k].Y;
                                    avgPos.Z -= buffer[i][j][k].Z;

                                    float inv = 1f / (float)(count - 1);
                                    avgPos.X *= inv; avgPos.Y *= inv; avgPos.Z *= inv;

                                    //Vector3 offset = new Vector3(avgPos.X - buffer[i][j][k].X, avgPos.Y - buffer[i][j][k].Y, avgPos.Z - buffer[i][j][k].Z);

                                    //avgPos.X *= 0.5f; avgPos.Y *= 0.5f; avgPos.Z *= 0.5f;


                                    avgPos.X += 0.5f * (avgPos.X - buffer[i][j][k].X);
                                    avgPos.Y += 0.5f * (avgPos.Y - buffer[i][j][k].Y);
                                    avgPos.Z += 0.5f * (avgPos.Z - buffer[i][j][k].Z);

                                    smoothed[i][j][k] = avgPos;
                                }
                                else
                                {
                                    smoothed[i][j][k] = buffer[i][j][k];
                                }
                            }
                        }



                    }
                }
            }

            for (int i = 0; i < vx; i++)
            {
                for (int j = 0; j < vy; j++)
                {
                    buffer[i][j] = null;
                }
                buffer[i] = null;
            }
            buffer = null;

            return smoothed;
        }
        Vector3[][][] CreatePosition(VoxelData[][][] data, VxlFlag[][][] passed, int ecx, int ecy, int ecz)
        {
            int vx = ecx + 1;
            int vy = ecy + 1;
            int vz = ecz + 1;

            Vector3[][][] buffer = new Vector3[vx][][];
            for (int i = 0; i < vx; i++)
            {
                buffer[i] = new Vector3[vy][];
                for (int j = 0; j < vy; j++)
                {
                    buffer[i][j] = new Vector3[vz];
                    for (int k = 0; k < vz; k++)
                    {
                        if (i < ecx && j < ecy && k < ecz)
                        {
                            buffer[i][j][k] = new Vector3(i * scale, j * scale, k * scale);
                        }
                        else
                        {
                            int ii = i;
                            int jj = j;
                            int kk = k;
                            if (ii == ecx)
                                ii--;

                            if (jj == ecy)
                                jj--;

                            if (kk == ecz)
                                kk--;

                            buffer[i][j][k] = new Vector3(i * scale, j * scale, k * scale);

                        }
                    }
                }
            }

            return buffer;
        }

        bool IsAdjacent(ref VxlFace a, ref VxlFace b)
        {
            bool result = false;
            for (int i = 0; i < 4; i++)
                for (int j = 0; j < 4; j++)
                {
                    int ea1 = i;
                    int ea2 = i == 3 ? 0 : i + 1;

                    int eb1 = j;
                    int eb2 = j == 3 ? 0 : j + 1;

                    if ((a.vtx[ea1] == b.vtx[eb1] && a.vtx[ea2] == b.vtx[eb2]) ||
                        (a.vtx[ea1] == b.vtx[eb2] && a.vtx[ea2] == b.vtx[eb1]))
                    {
                        result = true;
                        break;
                    }
                }
            return result;
        }

        AdjFaceInfo[][] CreateAdjFaceInfo(VxlFlag[] stateFlag, Vector3i[][] stateEnum)
        {
            Vector3i[] vxlPos = new Vector3i[27];
            VxlFace[] faces = new VxlFace[27 * 6];

            int index = 0;
            for (int a = -1; a < 2; a++)
                for (int b = -1; b < 2; b++)
                    for (int c = -1; c < 2; c++)
                    {
                        for (int k = 0; k < 6; k++)
                        {
                            faces[index] = new VxlFace();
                            for (int m = 0; m < 4; m++)
                            {
                                faces[index].vtx[m] = stateEnum[k][m];

                                faces[index].vtx[m].X += (short)a;
                                faces[index].vtx[m].Y += (short)b;
                                faces[index].vtx[m].Z += (short)c;
                            }
                            vxlPos[index++] = new Vector3i(a, b, c);                            
                        }
                    }

            VxlFace[] oface = new VxlFace[6];
            for (int k = 0; k < 6; k++)
            {
                faces[index] = new VxlFace();
                for (int m = 0; m < 4; m++)
                {
                    oface[k].vtx[m] = stateEnum[k][m];
                }
            }

            AdjFaceInfo[][] adjFaces = new AdjFaceInfo[6][];
            for (int i = 0; i < 6; i++)
            {
                List<AdjFaceInfo> adjs = new List<AdjFaceInfo>(25);
                for (int j = 0; j < 27 * 6; j++)
                {
                    if (oface[i] != faces[j])
                    {
                        if (IsAdjacent(ref oface[i], ref faces[j]))
                        {
                            AdjFaceInfo faceAdd;
                            faceAdd.face = stateFlag[j % 27];
                            faceAdd.vxlPos = vxlPos[j / 6];
                            adjs.Add(faceAdd);
                        }
                    }
                }
                adjFaces[i] = adjs.ToArray();
            }

            return adjFaces;
        }

        //Vector2[][][] BuildMaps(VoxelData[][][] data, VxlFlag[][][] passed, int ecx, int ecy, int ecz)
        //{
        //    int vx = ecx + 1;
        //    int vy = ecy + 1;
        //    int vz = ecz + 1;


        //    Bitmap normapMap = new Bitmap(512, 512, PixelFormat.Format32bppArgb);

        //    BitmapData ndata = normapMap.LockBits(new Rectangle(0, 0, 512, 512), ImageLockMode.WriteOnly, PixelFormat.Format32bppArgb);

        //    normapMap.UnlockBits(ndata);

        //    ImageQuadTreeNode manager = new ImageQuadTreeNode(512, 512, 32);

        //    for (int i = 0; i < ecx; i++)
        //    {
        //        for (int j = 0; j < ecy; j++)
        //        {
        //            int dep = -1;
        //            for (int k = 0; k < ecz; k++)
        //            {
        //                if (data[i][j][k].used && passed[i][j][k] != VxlFlag.None)
        //                {

        //                }
        //            }
        //        }
        //    }
        //}


        public unsafe override void Convert(ResourceLocation source, ResourceLocation dest)
        {
            HVA hva;

            VxlConvDlg dlg = new VxlConvDlg();
            dlg.ShowDialog();

            if (dlg.DialogResult == DialogResult.OK)
            {
                //hva = new HVA(new DevFileLocation(dlg.HVAFile));
                Palette = Palette.FromFile(new DevFileLocation(dlg.PaletteFile));
            }
            else
            {
                dlg.Dispose();
                return;
            }


            EditableModel texSrc = null;
            bool buildMap = false;
            bool smooth = dlg.Smooth;
            if (!string.IsNullOrEmpty(dlg.TexCoordSrc))
            {
                texSrc = EditableModel.FromFile(new DevFileLocation(dlg.TexCoordSrc));
                buildMap = true;
            }

            dlg.Dispose();



            Voxel vxl = new Voxel(source);

            VoxelSection[] sects = vxl.Section;

            EditableMesh[] meshes = new EditableMesh[sects.Length];
            Matrix[] trans = new Matrix[sects.Length];

            for (int s = 0; s < sects.Length; s++)
            {
                VoxelSection sect = sects[s];

                sect.GetTransform(out trans[s]);

                int cx = sect.XSize;
                int cy = sect.YSize;
                int cz = sect.ZSize;

                int ecx = cx + 2;
                int ecy = cy + 2;
                int ecz = cz + 2;


                VxlFlag[][][] passed = CreatePassedTable(ecx, ecy, ecz);

                VoxelData[][][] data = GetData(sect, ecx, ecy, ecz);

                MarkVxlFlags(data, passed, ecx, ecy, ecz);

                Vector3[][][] pos = CreatePosition(data, passed, ecx, ecy, ecz);
                Vector3[][][] smoothed;
                if (smooth)
                {
                    smoothed = CreateSmoothedPosition(data, passed, ecx, ecy, ecz);
                }
                else
                {
                    smoothed = pos;
                }

                //Dictionary<int, Texel> colorMap = new Dictionary<int, Texel>(ecx * ecy * ecz);
                //Dictionary<int, Texel> normalMap = new Dictionary<int, Texel>(ecx * ecy * ecz);

                //int[][] stateEnum = new int[6]
                //{
                //    new int[3] {0, 1, 0}, 
                //    new int[3] {0, -1, 0}, 
                //    new int[3] {1, 0, 0}, 
                //    new int[3] {-1, 0, 0},
                //    new int[3] {0, 0, 1},
                //    new int[3] {0, 0, -1}
                //};


                //for (int i = 0; i < ecx; i++)
                //{
                //    for (int j = 0; j < ecy; j++)
                //    {
                //        for (int k = 0; k < ecz; k++)
                //        {
                //            if ((passed[i][j][k] & VxlFlag.TexPassed) != 0)
                //            {
                //                Queue<Vector3i> q = new Queue<Vector3i>(ecx * ecy * ecz);
                //                Texel tex;
                //                tex.vxlX = (short)i;
                //                tex.vxlY = (short)j;
                //                tex.vxlZ = (short)k;
                //                tex.color = data[i][j][k].colour;
                //                tex.x = 0;
                //                tex.y = 0;

                //                int hash= tex.GetHashCode ();
                //                colorMap.Add(hash, tex);
                //                tex.color = data[i][j][k].normal;
                //                normalMap.Add(hash, tex);
                //                passed[i][j][k] |= VxlFlag.TexPassed;

                //                q.Enqueue(new Vector3i(tex.vxlX, tex.vxlY, tex.vxlZ));

                //                while (q.Count > 0)
                //                {
                //                    Vector3i cp = q.Dequeue();

                //                    for (int m = 0; m < 6; m++)
                //                    {
                //                        Vector3 np = cp;
                //                        np.X += stateEnum[m][0];
                //                        np.Y += stateEnum[m][0];
                //                        np.Z += stateEnum[m][0];

                //                        if ((passed[i][j][k] & VxlFlag.TexPassed) == 0)
                //                        {

                //                        }
                //                    }
                //                }
                //            }

                //        }
                //    }
                //}
                Dictionary<string, int> texSrcTable = null;
                if (buildMap)
                {
                    EditableMesh tsm = texSrc.Entities[s];
                    texSrcTable = new Dictionary<string, int>(30000);

                    for (int i = 0; i < tsm.Texture1.Length; i++)
                    {
                        Vector3 vpos = tsm.Positions[i];
                        vpos.Z = -vpos.Z;

                        if (!texSrcTable.ContainsKey(vpos.ToString()))
                        {
                            texSrcTable.Add(vpos.ToString(), i);
                        }
                    }
                }

                VxlFlag[] stateFlag = new VxlFlag[6]
                {
                    VxlFlag.FaceNegX,
                    VxlFlag.FaceNegY,
                    VxlFlag.FaceNegZ,
                    VxlFlag.FacePosX,
                    VxlFlag.FacePosY,
                    VxlFlag.FacePosZ
                };
                Vector3i[][] stateEnum = new Vector3i[6][]
                {
                    new Vector3i[4]
                    {
                        new Vector3i {X = 0, Y = 0, Z = 0},
                        new Vector3i {X = 0, Y = 1, Z = 0},
                        new Vector3i {X = 0, Y = 1, Z = 1},
                        new Vector3i {X = 0, Y = 0, Z = 1}
                    }, 
                    new Vector3i[4]
                    {
                        new Vector3i {X = 0, Y = 0, Z = 0},
                        new Vector3i {X = 1, Y = 0, Z = 0},
                        new Vector3i {X = 1, Y = 0, Z = 1},
                        new Vector3i {X = 0, Y = 0, Z = 1}
                    }, 
                    new Vector3i[4]
                    {
                        new Vector3i {X = 0, Y = 0, Z = 0},
                        new Vector3i {X = 1, Y = 0, Z = 0},
                        new Vector3i {X = 1, Y = 1, Z = 0},
                        new Vector3i {X = 0, Y = 1, Z = 0}
                    }, 

                    new Vector3i[4]
                    {
                        new Vector3i {X = 1, Y = 0, Z = 0},
                        new Vector3i {X = 1, Y = 1, Z = 0},
                        new Vector3i {X = 1, Y = 1, Z = 1},
                        new Vector3i {X = 1, Y = 0, Z = 1}
                    }, 
                    new Vector3i[4]
                    {
                        new Vector3i {X = 0, Y = 1, Z = 0},
                        new Vector3i {X = 1, Y = 1, Z = 0},
                        new Vector3i {X = 1, Y = 1, Z = 1},
                        new Vector3i {X = 0, Y = 1, Z = 1}
                    }, 
                    new Vector3i[4]
                    {
                        new Vector3i {X = 0, Y = 0, Z = 1},
                        new Vector3i {X = 1, Y = 0, Z = 1},
                        new Vector3i {X = 1, Y = 1, Z = 1},
                        new Vector3i {X = 0, Y = 1, Z = 1}
                    }
                };

                AdjFaceInfo[][] adjFaces = CreateAdjFaceInfo(stateFlag, stateEnum);

                List<MeshFace> faces = new List<MeshFace>(30000);

                List<VertexPNT1> vertices = new List<VertexPNT1>(30000);
                Dictionary<string, int> table = new Dictionary<string, int>(30000);

                Vector3[] normalTbl = Mode == Vxl2MdlMode.Ra2 ? ra2Normals : tsNormals;
                byte uBound = (byte)(normalTbl.Length - 1);


                const int MapLen = 128;

                Texture norTex = null;
                Texture clrTex = null;

                //BitmapData nbd = null;
                //BitmapData cbd = null;

                int* colorData = null;
                int* norData = null;
                if (buildMap)
                {
                    clrTex = new Texture(GraphicsDevice.Instance.Device, MapLen, MapLen, 1, Usage.None, Format.A8R8G8B8, Pool.Managed);
                    norTex = new Texture(GraphicsDevice.Instance.Device, MapLen, MapLen, 1, Usage.None, Format.A8R8G8B8, Pool.Managed);

                    //nbd = norTex.LockBits(new Rectangle(0, 0, MapLen, MapLen), ImageLockMode.WriteOnly, PixelFormat.Format32bppArgb);
                    //cbd = clrTex.LockBits(new Rectangle(0, 0, MapLen, MapLen), ImageLockMode.WriteOnly, PixelFormat.Format32bppArgb);
                    DataRectangle dataRect = clrTex.LockRectangle(0, LockFlags.None);
                    colorData = (int*)dataRect.Data.DataPointer.ToPointer();
                    dataRect = norTex.LockRectangle(0, LockFlags.None);
                    norData = (int*)dataRect.Data.DataPointer.ToPointer();
                    //norData = (int*)nbd.Scan0.ToPointer();
                    //colorData = (int*)cbd.Scan0.ToPointer();
                }
                


                for (int i = 0; i < ecx; i++)
                {
                    for (int j = 0; j < ecy; j++)
                    {
                        for (int k = 0; k < ecz; k++)
                        {
                            for (int m = 0; m < 6; m++)
                            {
                                if ((passed[i][j][k] & stateFlag[m]) != 0)
                                {
                                    if (data[i][j][k].normal > uBound)
                                        data[i][j][k].normal = uBound;
                                    Vector3 fn = normalTbl[data[i][j][k].normal];
                                    VertexPNT1[] vtx = new VertexPNT1[4];

                                    for (int p = 0; p < 4; p++)
                                    {
                                        Vector3i vPos = new Vector3i(i + stateEnum[m][p].X, j + stateEnum[m][p].Y, k + stateEnum[m][p].Z);

                                        vtx[p].pos = smoothed[vPos.X][vPos.Y][vPos.Z];
                                        vtx[p].n = fn;

                                        int idx;
                                        if (buildMap && texSrcTable.TryGetValue(pos[vPos.X][vPos.Y][vPos.Z].ToString(), out idx))
                                        {
                                            vtx[p].u = texSrc.Entities[s].Texture1[idx].X;
                                            vtx[p].v = texSrc.Entities[s].Texture1[idx].Y;


                                            int ty = (int)(MapLen * vtx[p].v);
                                            int tx = (int)(MapLen * vtx[p].u);

                                            int texPos = ty * MapLen + tx;
                                            colorData[texPos] = Palette.Data[data[i][j][k].colour].ToArgb();
                                            norData[texPos] = (0xff << 24) | (((byte)(127f * fn.X + 128f)) << 16) | (((byte)(127f * fn.Y + 128f)) << 8) | ((byte)(127f * fn.Z + 128f));

                                        }
                                        else
                                        {
                                            vtx[p].u = 0;
                                            vtx[p].v = 0;
                                        }
                                    }

                                    AddQuad(ref vtx[0], ref vtx[1], ref vtx[2], ref vtx[3], faces, vertices, table);


                                }
                            }
                        }
                    }
                }




                if (buildMap)
                {
                    //clrTex.UnlockBits(cbd);
                    //norTex.UnlockBits(nbd);
                    clrTex.UnlockRectangle(0);
                    norTex.UnlockRectangle(0);

                    //Texture.ToFile(clrTex, @"C:\Documents and Settings\Yuri\桌面\c.png", ImageFileFormat.Png);
                    //Texture.ToFile(norTex, @"C:\Documents and Settings\Yuri\桌面\n.png", ImageFileFormat.Png);

                    //clrTex.Save(@"C:\Documents and Settings\Yuri\桌面\c.png", ImageFormat.Png);
                    //norTex.Save(@"C:\Documents and Settings\Yuri\桌面\n.png", ImageFormat.Png);
                }



                EditableMesh mesh = new EditableMesh();

                Vector3[] positions = new Vector3[vertices.Count];
                Vector3[] n = new Vector3[vertices.Count];
                Vector2[] tex1 = new Vector2[vertices.Count];

                for (int i = 0; i < vertices.Count; i++)
                {
                    VertexPNT1 vtx = vertices[i];
                    positions[i] = vertices[i].pos;
                    n[i] = vertices[i].n;
                    tex1[i] = new Vector2(vtx.u, vtx.v);
                }

                mesh.Positions = positions;
                mesh.Normals = n;
                mesh.Texture1 = tex1;

                mesh.Name = sect.Name;

                EditableMeshMaterial mate = new EditableMeshMaterial();
                mate.mat = MeshMaterial.DefaultMatColor;
                mate.Texture1 = clrTex;
                mate.Texture2 = norTex;
                mate.EffectName = buildMap ? "NormapMapping" : string.Empty;

                DevFileLocation fl = source as DevFileLocation;
                if (fl != null)
                {
                    mate.TextureFile1 = Path.GetFileNameWithoutExtension(fl.Path) + "c.png";
                    mate.TextureFile2 = Path.GetFileNameWithoutExtension(fl.Path) + "n.png";

                    DevFileLocation dfl = dest as DevFileLocation;

                    if (dfl != null)
                    {
                        string path = Path.GetDirectoryName(dfl.Path);
                        Texture.ToFile(clrTex, Path.Combine(path, mate.TextureFile1), ImageFileFormat.Png);
                        Texture.ToFile(norTex, Path.Combine(path, mate.TextureFile2), ImageFileFormat.Png);

                        mate.Texture1Embeded = false;
                        mate.Texture2Embeded = false;
                    }
                    else
                    {
                        mate.Texture1Embeded = true;
                        mate.Texture2Embeded = true;
                    }
                }
                else
                {
                    mate.Texture1Embeded = true;
                    mate.Texture2Embeded = true;
                }

                mesh.Materials = new EditableMeshMaterial[1] { mate };

                mesh.Faces = faces.ToArray();
                mesh.Format = VertexPNT1.Format;

                meshes[s] = mesh;
            }


            EditableModel mdl = new EditableModel();


            //for (int i = 0; i < meshes.Length; i++)
            //{
            //    MeshSimpDlg prev = new MeshSimpDlg(meshes[i]);


            //    prev.ShowDialog();
            //    if (meshes[i] != prev.SelectedMesh)
            //    {
            //        meshes[i].Dispose();
            //        meshes[i] = prev.SelectedMesh;
            //    }


            //    prev.Dispose();
            //}

#warning hva anim
            mdl.Entities = meshes;
            mdl.ModelAnimation = new NoAnimation(GraphicsDevice.Instance.Device, trans);

            EditableModel.ToFile(mdl, dest);

            mdl.Dispose();
        }



        public override void ShowDialog(object sender, EventArgs e)
        {
            string[] files;
            string path;
            if (ConvDlg.Show(Program.StringTable[CsfKey], GetOpenFilter(), out files, out path) == DialogResult.OK)
            {
                ProgressDlg pd = new ProgressDlg(Program.StringTable["GUI:Converting"]);

                pd.MinVal = 0;
                pd.Value = 0;
                pd.MaxVal = files.Length;

                pd.Show();
                for (int i = 0; i < files.Length; i++)
                {
                    string dest = Path.Combine(path, Path.GetFileNameWithoutExtension(files[i]) + ".mesh");

                    Convert(new DevFileLocation(files[i]), new DevFileLocation(dest));
                    pd.Value = i;
                }
                pd.Close();
                pd.Dispose();
            }
        }

        public override string Name
        {
            get { return Program.StringTable[CsfKey]; }
        }

        public override string[] SourceExt
        {
            get { return new string[] { ".vxl" }; }
        }
        public override string[] DestExt
        {
            get { return new string[] { ".mesh" }; }
        }
        public override string DestDesc
        {
            get { return Program.StringTable["DOCS:MESHDESC"]; }
        }
        public override string SourceDesc
        {
            get { return Program.StringTable["DOCS:VxlDesc"]; }
        }
     }
}
